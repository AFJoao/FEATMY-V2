<div class="student-dashboard" style="font-family: 'DM Sans', system-ui, sans-serif; background: #FFFFFF; min-height: 100vh;">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600;700;800&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/mobile-responsive-fixes.css">

  <style>
    .day-col {
      background: #fff;
      border: 1px solid #EBEBEB;
      border-radius: 16px;
      overflow: hidden;
      transition: all 0.25s cubic-bezier(0.4,0,0.2,1);
      display: flex;
      flex-direction: column;
    }
    .day-col-today {
      background: #0A0A0A;
      border-color: #0A0A0A;
      box-shadow: 0 8px 32px rgba(10,10,10,0.15);
    }
    .exercise-pill {
      border-radius: 10px;
      padding: 11px 13px;
      transition: all 0.2s ease;
    }
    .exercise-pill:hover {
      transform: translateX(2px);
    }
    .feedback-btn {
      width: 100%;
      padding: 9px;
      border: none;
      border-radius: 8px;
      font-size: 0.75rem;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s cubic-bezier(0.4,0,0.2,1);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      letter-spacing: 0.01em;
    }
    .feedback-btn-dark {
      background: #00E676;
      color: #0A0A0A;
    }
    .feedback-btn-dark:hover {
      background: #00C853;
      box-shadow: 0 4px 14px rgba(0,230,118,0.35);
    }
    .feedback-btn-light {
      background: #0A0A0A;
      color: #fff;
    }
    .feedback-btn-light:hover {
      background: #1a1a1a;
      box-shadow: 0 4px 14px rgba(0,0,0,0.2);
    }
    .logout-nav-btn {
      color: rgba(255,255,255,0.7);
      background: transparent;
      border: 1px solid rgba(255,255,255,0.14);
      padding: 8px 16px;
      border-radius: 8px;
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 7px;
    }
    .logout-nav-btn:hover {
      background: rgba(255,255,255,0.09);
      border-color: rgba(255,255,255,0.3);
      color: #fff;
    }
    .spinner {
      border: 3px solid rgba(0,0,0,0.06);
      border-top-color: #00E676;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Modal */
    .modal-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(10,10,10,0.65);
      backdrop-filter: blur(4px);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    .modal-card {
      background: #fff;
      border-radius: 20px;
      padding: 32px;
      max-width: 480px;
      width: 92%;
      max-height: 88vh;
      overflow-y: auto;
      box-shadow: 0 24px 64px rgba(0,0,0,0.2);
    }
    .sensation-label {
      flex: 1;
      min-width: 100px;
      padding: 12px;
      border: 2px solid #EBEBEB;
      border-radius: 10px;
      cursor: pointer;
      text-align: center;
      transition: all 0.2s ease;
    }
    .sensation-label:hover { border-color: #0A0A0A; }
    .sensation-label.selected { border-color: #00E676; background: rgba(0,230,118,0.06); }
    .pain-label {
      flex: 1;
      padding: 12px;
      border: 2px solid #EBEBEB;
      border-radius: 10px;
      cursor: pointer;
      text-align: center;
      transition: all 0.2s ease;
    }
    .pain-label:hover { border-color: #0A0A0A; }
    .pain-label.selected { border-color: #0A0A0A; background: #F4F4F4; }

    /* FIX: slider verde progressivo */
    .range-input {
      -webkit-appearance: none;
      height: 6px;
      border-radius: 3px;
      background: linear-gradient(to right, #00E676 44.4%, #EBEBEB 44.4%); /* valor inicial 5 de 10 */
      outline: none;
      flex: 1;
      transition: background 0.1s;
    }
    .range-input::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: #00E676;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(0,230,118,0.4);
    }
    .range-input::-moz-range-thumb {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: #00E676;
      cursor: pointer;
      border: none;
      box-shadow: 0 2px 8px rgba(0,230,118,0.4);
    }
    .modal-input {
      width: 100%;
      padding: 12px 14px;
      border: 2px solid #EBEBEB;
      border-radius: 10px;
      font-size: 0.9rem;
      outline: none;
      transition: border-color 0.2s;
      box-sizing: border-box;
      font-family: inherit;
    }
    .modal-input:focus { border-color: #0A0A0A; }
  </style>

  <!-- HEADER -->
  <header style="background: #0A0A0A; position: sticky; top: 0; z-index: 50; border-bottom: 1px solid rgba(255,255,255,0.06);">
    <div style="max-width: 1400px; margin: 0 auto; padding: 0 32px; height: 64px; display: flex; justify-content: space-between; align-items: center;">
      <div style="display: flex; align-items: center; gap: 12px;">
        <img src="assets/branca_larga.png" style="height: 28px; object-fit: contain;" onerror="this.style.display='none'">
        <span style="background: rgba(0,230,118,0.12); color: #00E676; font-size: 0.65rem; font-weight: 700; padding: 2px 8px; border-radius: 20px; letter-spacing: 0.04em; text-transform: uppercase; border: 1px solid rgba(0,230,118,0.2);">Aluno</span>
      </div>
      <button id="logoutBtn" class="logout-nav-btn">
        <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/>
        </svg>
        Sair
      </button>
    </div>
  </header>

  <!-- MAIN -->
  <main style="max-width: 1400px; margin: 0 auto; padding: 36px 32px 60px;">

    <!-- Welcome -->
    <div style="margin-bottom: 32px;">
      <p style="color: #9CA3AF; font-size: 0.8rem; font-weight: 600; margin: 0 0 6px; letter-spacing: 0.06em; text-transform: uppercase;">Seus Treinos</p>
      <h1 style="font-size: 1.9rem; font-weight: 800; color: #0A0A0A; margin: 0; letter-spacing: -0.03em;">OlÃ¡, <span id="studentName">...</span>! ðŸ‘‹</h1>
      <p style="color: #6B7280; font-size: 0.9rem; margin: 8px 0 0;">Confira sua programaÃ§Ã£o semanal</p>
    </div>

    <!-- Weekly grid -->
    <div id="weeklyWorkouts" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 12px;">
      <div style="grid-column:1/-1; text-align:center; padding:60px 20px;">
        <div class="spinner" style="width:28px;height:28px;margin:0 auto 16px;"></div>
        <p style="color:#9CA3AF;font-size:0.875rem;margin:0;">Carregando semana...</p>
      </div>
    </div>
  </main>

  <!-- FEEDBACK MODAL -->
  <div id="feedbackModal" class="modal-overlay">
    <div class="modal-card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;">
        <div>
          <p style="color:#9CA3AF;font-size:0.7rem;font-weight:700;letter-spacing:0.08em;text-transform:uppercase;margin:0 0 4px;">AVALIAÃ‡ÃƒO DO TREINO</p>
          <h3 style="font-size:1.3rem;font-weight:800;color:#0A0A0A;margin:0;letter-spacing:-0.02em;">Enviar Feedback</h3>
        </div>
        <!-- FIX: cor explÃ­cita no stroke do SVG para garantir visibilidade -->
        <button 
  id="closeFeedbackModal"
  type="button"
  style="
    background:#F4F4F4;
    border:none;
    width:36px;
    height:36px;
    border-radius:10px;
    cursor:pointer;
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:1.2rem;
    font-weight:700;
    color:#374151;
    transition:background 0.2s;
  "
  onmouseover="this.style.background='#EBEBEB'"
  onmouseout="this.style.background='#F4F4F4'"
>
  âœ•
</button>
      </div>

      <form id="feedbackForm">
        <input type="hidden" id="feedbackWorkoutId">
        <input type="hidden" id="feedbackDayOfWeek">

        <!-- Effort Level -->
        <div style="margin-bottom:22px;">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
            <label style="font-size:0.85rem;font-weight:700;color:#0A0A0A;">NÃ­vel de EsforÃ§o</label>
            <div style="background:#0A0A0A;color:#00E676;border-radius:8px;padding:4px 12px;display:flex;align-items:center;gap:4px;">
              <span id="effortLevelValue" style="font-size:1.1rem;font-weight:800;">5</span>
              <span style="font-size:0.75rem;color:rgba(0,230,118,0.6);">/10</span>
            </div>
          </div>
          <input type="range" id="effortLevel" class="range-input" min="1" max="10" value="5" style="width:100%;">
          <div style="display:flex;justify-content:space-between;margin-top:6px;">
            <span style="font-size:0.72rem;color:#9CA3AF;">Muito leve</span>
            <span style="font-size:0.72rem;color:#9CA3AF;">MÃ¡ximo</span>
          </div>
        </div>

        <!-- SensaÃ§Ã£o -->
        <div style="margin-bottom:22px;">
          <label style="display:block;font-size:0.85rem;font-weight:700;color:#0A0A0A;margin-bottom:10px;">SensaÃ§Ã£o Geral</label>
          <div style="display:flex;gap:8px;">
            <label class="sensation-label" id="sensationLeve">
              <input type="radio" name="sensation" value="leve" style="display:none;">
              <div style="font-size:1.2rem;margin-bottom:4px;">ðŸ˜Œ</div>
              <span style="font-size:0.8rem;font-weight:600;color:#374151;">Leve</span>
            </label>
            <label class="sensation-label selected" id="sensationIdeal">
              <input type="radio" name="sensation" value="ideal" checked style="display:none;">
              <div style="font-size:1.2rem;margin-bottom:4px;">ðŸŽ¯</div>
              <span style="font-size:0.8rem;font-weight:600;color:#374151;">Ideal</span>
            </label>
            <label class="sensation-label" id="sensationPesado">
              <input type="radio" name="sensation" value="pesado" style="display:none;">
              <div style="font-size:1.2rem;margin-bottom:4px;">ðŸ”¥</div>
              <span style="font-size:0.8rem;font-weight:600;color:#374151;">Pesado</span>
            </label>
          </div>
        </div>

        <!-- Dor -->
        <div style="margin-bottom:22px;">
          <label style="display:block;font-size:0.85rem;font-weight:700;color:#0A0A0A;margin-bottom:10px;">Sentiu Dor ou Desconforto?</label>
          <div style="display:flex;gap:8px;">
            <label class="pain-label" id="hasPainSim">
              <input type="radio" name="hasPain" value="true" style="display:none;">
              <span style="font-size:0.85rem;font-weight:600;color:#374151;">Sim</span>
            </label>
            <label class="pain-label selected" id="hasPainNao">
              <input type="radio" name="hasPain" value="false" checked style="display:none;">
              <span style="font-size:0.85rem;font-weight:600;color:#374151;">NÃ£o</span>
            </label>
          </div>
        </div>

        <div id="painLocationContainer" style="margin-bottom:22px;display:none;">
          <label style="display:block;font-size:0.85rem;font-weight:700;color:#0A0A0A;margin-bottom:8px;">Local da Dor</label>
          <input type="text" id="painLocation" class="modal-input" placeholder="Ex: Ombro direito, joelho esquerdo...">
        </div>

        <div style="margin-bottom:24px;">
          <label style="display:block;font-size:0.85rem;font-weight:700;color:#0A0A0A;margin-bottom:8px;">ComentÃ¡rio <span style="font-weight:400;color:#9CA3AF;">(opcional)</span></label>
          <textarea id="feedbackComment" class="modal-input" rows="3" placeholder="Como foi o treino hoje?"></textarea>
        </div>

        <div style="display:flex;gap:10px;">
          <button type="button" id="cancelFeedbackBtn" style="flex:1;padding:13px;border:2px solid #EBEBEB;border-radius:10px;background:#fff;color:#6B7280;font-size:0.875rem;font-weight:600;cursor:pointer;transition:all 0.2s;" onmouseover="this.style.borderColor='#0A0A0A';this.style.color='#0A0A0A'" onmouseout="this.style.borderColor='#EBEBEB';this.style.color='#6B7280'">Cancelar</button>
          <button type="submit" style="flex:2;padding:13px;border:none;border-radius:10px;background:#00E676;color:#0A0A0A;font-size:0.875rem;font-weight:800;cursor:pointer;transition:all 0.25s;" onmouseover="this.style.background='#00C853';this.style.boxShadow='0 6px 20px rgba(0,230,118,0.35)'" onmouseout="this.style.background='#00E676';this.style.boxShadow='none'">
            Enviar Feedback
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
if (typeof window.feedbackModel === 'undefined') {
  window.feedbackModel = {
    getCurrentWeekIdentifier: function() {
      const now = new Date();
      const startOfYear = new Date(now.getFullYear(), 0, 1);
      const pastDaysOfYear = (now - startOfYear) / 86400000;
      const weekNumber = Math.ceil((pastDaysOfYear + startOfYear.getDay() + 1) / 7);
      return `${now.getFullYear()}-${weekNumber}`;
    },
    getFeedbackKey: function(studentId, workoutId, weekIdentifier, dayOfWeek) {
      return `${studentId}_${workoutId}_${weekIdentifier}_${dayOfWeek}`;
    },
    validateFeedbackData: function(data) {
      const errors = [];
      if (!data.studentId || typeof data.studentId !== 'string') errors.push('studentId Ã© obrigatÃ³rio');
      if (!data.workoutId || typeof data.workoutId !== 'string') errors.push('workoutId Ã© obrigatÃ³rio');
      if (!data.weekIdentifier || typeof data.weekIdentifier !== 'string') errors.push('weekIdentifier Ã© obrigatÃ³rio');
      if (!data.dayOfWeek || !['monday','tuesday','wednesday','thursday','friday','saturday','sunday'].includes(data.dayOfWeek)) errors.push('dayOfWeek invÃ¡lido');
      if (typeof data.effortLevel !== 'number' || data.effortLevel < 1 || data.effortLevel > 10) errors.push('effortLevel deve ser um nÃºmero entre 1 e 10');
      if (!['leve','ideal','pesado'].includes(data.sensation)) errors.push('sensation invÃ¡lido');
      if (typeof data.hasPain !== 'boolean') errors.push('hasPain deve ser boolean');
      if (data.hasPain && (!data.painLocation || data.painLocation.trim() === '')) errors.push('painLocation obrigatÃ³rio');
      return { isValid: errors.length === 0, errors };
    }
  };
}

(async function() {
  const daysMap = {
    monday:    { name: 'Segunda', short: 'SEG' },
    tuesday:   { name: 'TerÃ§a',   short: 'TER' },
    wednesday: { name: 'Quarta',  short: 'QUA' },
    thursday:  { name: 'Quinta',  short: 'QUI' },
    friday:    { name: 'Sexta',   short: 'SEX' },
    saturday:  { name: 'SÃ¡bado',  short: 'SÃB' },
    sunday:    { name: 'Domingo', short: 'DOM' }
  };
  const daysOrder = ['monday','tuesday','wednesday','thursday','friday','saturday','sunday'];

  const jsToKey = { 0:'sunday', 1:'monday', 2:'tuesday', 3:'wednesday', 4:'thursday', 5:'friday', 6:'saturday' };
  const todayKey = jsToKey[new Date().getDay()];

  await new Promise(resolve => document.readyState === 'loading' ? document.addEventListener('DOMContentLoaded', resolve) : resolve());
  await new Promise(resolve => setTimeout(resolve, 100));

  const logoutBtn = document.getElementById('logoutBtn');
  if (logoutBtn) {
    logoutBtn.addEventListener('click', async () => {
      await authManager.logout();
      router.goToLogin();
    });
  }

  window.viewWorkoutFunc = function(workoutId, dayKey) {
    sessionStorage.setItem('viewWorkoutId', workoutId);
    if (dayKey) sessionStorage.setItem('viewWorkoutDay', dayKey);
    router.goToViewWorkout();
  };

  async function loadStudentData() {
    const userData = await dbManager.getCurrentUserData();
    const el = document.getElementById('studentName');
    if (el && userData) el.textContent = userData.name || 'Aluno';
  }

  async function loadWorkouts() {
    const workouts = await dbManager.getStudentWorkouts();
    const weeklyContainer = document.getElementById('weeklyWorkouts');

    if (!workouts || workouts.length === 0) {
      weeklyContainer.innerHTML = `
        <div style="grid-column:1/-1;text-align:center;padding:60px 20px;background:#FAFAFA;border-radius:16px;border:2px dashed #E5E7EB;">
          <div style="width:56px;height:56px;background:#F4F4F4;border-radius:16px;margin:0 auto 16px;display:flex;align-items:center;justify-content:center;">
            <svg width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="#9CA3AF" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
          </div>
          <p style="color:#374151;font-size:1rem;font-weight:700;margin:0 0 6px;">Nenhum treino atribuÃ­do</p>
          <p style="color:#9CA3AF;font-size:0.85rem;margin:0;">Aguarde seu personal trainer configurar seus treinos</p>
        </div>
      `;
      return;
    }

    const weeklyWorkouts = {};
    daysOrder.forEach(day => { weeklyWorkouts[day] = []; });
    workouts.forEach(workout => {
      if (workout.days) {
        Object.keys(workout.days).forEach(day => {
          if (workout.days[day] && workout.days[day].length > 0) {
            weeklyWorkouts[day].push(workout);
          }
        });
      }
    });

    weeklyContainer.innerHTML = daysOrder.map(day => {
      const isToday = day === todayKey;
      return `
        <div class="day-col ${isToday ? 'day-col-today' : ''}">
          <div style="padding:14px 14px 10px;${isToday ? 'border-bottom:1px solid rgba(255,255,255,0.1);' : 'border-bottom:1px solid #EBEBEB;'}">
            <div style="font-size:0.65rem;font-weight:700;letter-spacing:0.1em;text-transform:uppercase;color:${isToday ? 'rgba(0,230,118,0.7)' : '#9CA3AF'};margin-bottom:3px;">${daysMap[day].short}</div>
            <div style="font-size:0.95rem;font-weight:700;color:${isToday ? '#fff' : '#0A0A0A'};">${daysMap[day].name}</div>
            ${isToday ? '<div style="width:24px;height:2px;background:#00E676;border-radius:2px;margin-top:6px;"></div>' : ''}
          </div>
          <div id="day-${day}-workouts" style="flex:1;padding:10px;display:flex;flex-direction:column;gap:6px;">
            <div style="display:flex;align-items:center;justify-content:center;padding:20px 8px;flex:1;">
              <div class="spinner" style="width:18px;height:18px;border-width:2px;${isToday ? 'border-color:rgba(255,255,255,0.15);border-top-color:#00E676;' : ''}"></div>
            </div>
          </div>
        </div>
      `;
    }).join('');

    for (const day of daysOrder) {
      const dayWorkouts = weeklyWorkouts[day];
      const dayContainer = document.getElementById(`day-${day}-workouts`);
      const isToday = day === todayKey;

      if (dayWorkouts.length === 0) {
        dayContainer.innerHTML = `
          <div style="flex:1;display:flex;align-items:center;justify-content:center;padding:20px 8px;">
            <div style="text-align:center;">
              <div style="width:28px;height:28px;border-radius:8px;background:${isToday ? 'rgba(255,255,255,0.08)' : '#F4F4F4'};margin:0 auto 8px;display:flex;align-items:center;justify-content:center;">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="${isToday ? 'rgba(255,255,255,0.3)' : '#CBD5E1'}" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>
              </div>
              <p style="font-size:0.7rem;color:${isToday ? 'rgba(255,255,255,0.3)' : '#CBD5E1'};margin:0;font-weight:500;">Descanso</p>
            </div>
          </div>
        `;
        continue;
      }

      let dayHTML = '';

      for (const w of dayWorkouts) {
        const exercises = w.days[day] || [];

        let hasFeedback = false;
        try {
          const weekIdentifier = window.feedbackModel.getCurrentWeekIdentifier();
          if (typeof dbManager.hasFeedbackForDay === 'function') {
            hasFeedback = await dbManager.hasFeedbackForDay(w.id, day, weekIdentifier);
          }
        } catch (e) {
          hasFeedback = false;
        }

        for (const exercise of exercises) {
          const exerciseName = exercise.exerciseName || exercise.name || 'ExercÃ­cio';
          const sets = exercise.sets || '-';
          const reps = exercise.reps || '-';
          const weight = exercise.weight || '';

          dayHTML += `
            <div class="exercise-pill"
              style="background:${isToday ? 'rgba(255,255,255,0.07)' : '#F8F9FA'};border:1px solid ${isToday ? 'rgba(255,255,255,0.1)' : '#EBEBEB'};cursor:pointer;"
              onclick="viewWorkoutFunc('${w.id}', '${day}')">
              <p style="font-weight:700;font-size:0.78rem;color:${isToday ? '#fff' : '#0A0A0A'};margin:0 0 6px;line-height:1.3;">${exerciseName}</p>
              <div style="display:flex;gap:5px;flex-wrap:wrap;">
                <span style="background:${isToday ? 'rgba(0,230,118,0.2)' : '#0A0A0A'};color:${isToday ? '#00E676' : '#fff'};padding:2px 8px;border-radius:5px;font-size:0.68rem;font-weight:700;">${sets}Ã—${reps}</span>
                ${weight ? `<span style="background:${isToday ? 'rgba(255,255,255,0.12)' : '#F4F4F4'};color:${isToday ? 'rgba(255,255,255,0.7)' : '#6B7280'};padding:2px 8px;border-radius:5px;font-size:0.68rem;font-weight:600;">${weight}</span>` : ''}
              </div>
            </div>
          `;
        }

        if (exercises.length > 0) {
          dayHTML += hasFeedback
            ? `<div style="display:flex;align-items:center;justify-content:center;gap:5px;padding:7px;border-radius:8px;background:${isToday ? 'rgba(0,230,118,0.1)' : '#F0FFF4'};border:1px solid ${isToday ? 'rgba(0,230,118,0.2)' : '#D1FAE5'};">
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="${isToday ? '#00E676' : '#059669'}" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg>
                <span style="font-size:0.72rem;font-weight:700;color:${isToday ? '#00E676' : '#059669'};">Feedback enviado</span>
              </div>`
            : `<button
                onclick="event.stopPropagation(); openFeedbackModal('${w.id}', '${day}')"
                class="feedback-btn ${isToday ? 'feedback-btn-dark' : 'feedback-btn-light'}">
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
                Feedback
              </button>`;
        }
      }

      dayContainer.innerHTML = dayHTML;
    }
  }

  window.openFeedbackModal = function(workoutId, dayOfWeek) {
    const modal = document.getElementById('feedbackModal');
    document.getElementById('feedbackWorkoutId').value = workoutId;
    document.getElementById('feedbackDayOfWeek').value = dayOfWeek;
    // Reset slider
    const slider = document.getElementById('effortLevel');
    slider.value = 5;
    document.getElementById('effortLevelValue').textContent = '5';
    updateSliderGradient(slider);
    if (modal) modal.style.display = 'flex';
  };

  function closeModal() {
    const modal = document.getElementById('feedbackModal');
    if (modal) modal.style.display = 'none';
  }

  document.getElementById('closeFeedbackModal')?.addEventListener('click', closeModal);
  document.getElementById('cancelFeedbackBtn')?.addEventListener('click', closeModal);
  document.getElementById('feedbackModal')?.addEventListener('click', e => {
    if (e.target === e.currentTarget) closeModal();
  });

  // FIX: funÃ§Ã£o para atualizar gradiente do slider
  function updateSliderGradient(input) {
    const pct = (input.value - input.min) / (input.max - input.min) * 100;
    input.style.background = `linear-gradient(to right, #00E676 ${pct}%, #EBEBEB ${pct}%)`;
  }

  const effortLevel = document.getElementById('effortLevel');
  const effortLevelValue = document.getElementById('effortLevelValue');
  if (effortLevel && effortLevelValue) {
    // Inicializar gradiente
    updateSliderGradient(effortLevel);
    effortLevel.addEventListener('input', e => {
      effortLevelValue.textContent = e.target.value;
      updateSliderGradient(e.target);
    });
  }

  const hasPainInputs = document.querySelectorAll('input[name="hasPain"]');
  const painLocationContainer = document.getElementById('painLocationContainer');
  hasPainInputs.forEach(input => {
    input.addEventListener('change', e => {
      painLocationContainer.style.display = e.target.value === 'true' ? 'block' : 'none';
      document.querySelectorAll('.pain-label').forEach(l => l.classList.remove('selected'));
      e.target.closest('.pain-label').classList.add('selected');
    });
  });

  document.querySelectorAll('.sensation-label').forEach(label => {
    const radio = label.querySelector('input[type="radio"]');
    if (radio) {
      radio.addEventListener('change', () => {
        document.querySelectorAll('.sensation-label').forEach(l => l.classList.remove('selected'));
        label.classList.add('selected');
      });
    }
  });

  document.querySelectorAll('.pain-label').forEach(label => {
    const radio = label.querySelector('input[type="radio"]');
    if (radio && radio.checked) label.classList.add('selected');
    label.addEventListener('click', () => {
      document.querySelectorAll('.pain-label').forEach(l => l.classList.remove('selected'));
      label.classList.add('selected');
    });
  });

  const feedbackForm = document.getElementById('feedbackForm');
  if (feedbackForm) {
    feedbackForm.addEventListener('submit', async e => {
      e.preventDefault();
      const workoutId = document.getElementById('feedbackWorkoutId').value;
      const dayOfWeek = document.getElementById('feedbackDayOfWeek').value;
      const effortLevelVal = parseInt(document.getElementById('effortLevel').value);
      const sensation = document.querySelector('input[name="sensation"]:checked')?.value;
      const hasPain = document.querySelector('input[name="hasPain"]:checked')?.value === 'true';
      const painLocation = document.getElementById('painLocation').value;
      const comment = document.getElementById('feedbackComment').value;
      const weekIdentifier = window.feedbackModel?.getCurrentWeekIdentifier();

      const result = await dbManager.createFeedback({
        workoutId, dayOfWeek, effortLevel: effortLevelVal, sensation, hasPain,
        painLocation: hasPain ? painLocation : '',
        comment: comment || '', weekIdentifier
      });

      if (result.success) {
        alert('Feedback enviado com sucesso!');
        closeModal();
        feedbackForm.reset();
        const sl = document.getElementById('effortLevel');
        sl.value = 5;
        document.getElementById('effortLevelValue').textContent = '5';
        updateSliderGradient(sl);
        painLocationContainer.style.display = 'none';
        await loadWorkouts();
      } else {
        alert('Erro ao enviar feedback: ' + result.error);
      }
    });
  }

  await loadStudentData();
  await loadWorkouts();
})();
</script>

<style>
@media (max-width: 1024px) {
  #weeklyWorkouts { grid-template-columns: repeat(4, 1fr) !important; }
}
@media (max-width: 640px) {
  #weeklyWorkouts { grid-template-columns: repeat(2, 1fr) !important; }
}
</style>
<div class="primeiro-acesso-page" style="font-family: 'DM Sans', system-ui, sans-serif; background: #FFFFFF; min-height: 100vh; display: flex;">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/mobile-responsive-fixes.css">

  <style>
    .pa-input {
      width: 100%; padding: 13px 16px; border: 2px solid #EBEBEB; border-radius: 12px;
      font-size: 0.9rem; outline: none; transition: all 0.2s ease; box-sizing: border-box;
      font-family: inherit; background: #FAFAFA; color: #0A0A0A;
    }
    .pa-input:focus { border-color: #0A0A0A; background: #fff; box-shadow: 0 0 0 4px rgba(0,0,0,0.04); }
    .pa-input::placeholder { color: #9CA3AF; }
    .pa-btn {
      width: 100%; padding: 14px; background: #00E676; color: #0A0A0A; border: none;
      border-radius: 12px; font-size: 0.95rem; font-weight: 800; cursor: pointer;
      transition: all 0.25s cubic-bezier(0.4,0,0.2,1); font-family: inherit;
    }
    .pa-btn:hover { background: #00C853; transform: translateY(-1px); box-shadow: 0 8px 24px rgba(0,230,118,0.35); }
    .pa-btn:disabled { opacity: 0.55; cursor: not-allowed; transform: none; box-shadow: none; }
    .spinner { width: 22px; height: 22px; border: 3px solid rgba(0,0,0,0.08); border-top-color: #00E676; border-radius: 50%; animation: spin 0.8s linear infinite; display: inline-block; vertical-align: middle; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Step transitions */
    .step { display: none; }
    .step.active { display: block; }
  </style>

  <!-- LEFT PANEL -->
  <div class="pa-left" style="width: 44%; background: #0A0A0A; display: flex; flex-direction: column; justify-content: space-between; padding: 48px; position: relative; overflow: hidden; flex-shrink: 0;">
    <div style="position: absolute; inset: 0; background: radial-gradient(ellipse at 25% 75%, rgba(0,230,118,0.08) 0%, transparent 55%); pointer-events: none;"></div>

    <div style="position: relative; flex: 1; display: flex; align-items: center; justify-content: center;">
      <img src="assets/branca_larga.png" alt="Featym" style="width: 72%; max-width: 320px; object-fit: contain; filter: drop-shadow(0 0 40px rgba(0,230,118,0.12));" onerror="this.style.display='none'">
    </div>

    <div style="position: relative;">
      <p style="color: rgba(0,230,118,0.75); font-size: 0.72rem; font-weight: 700; letter-spacing: 0.1em; text-transform: uppercase; margin: 0 0 14px;">Primeiro acesso</p>
      <h2 style="color: #fff; font-size: 2rem; font-weight: 800; margin: 0 0 16px; line-height: 1.2; letter-spacing: -0.03em;">Bem-vindo à<br>sua jornada<br>fitness.</h2>
      <p style="color: rgba(255,255,255,0.4); font-size: 0.85rem; line-height: 1.7; margin: 0; max-width: 300px;">Seu personal trainer já criou sua conta. Defina uma senha para começar a acessar seus treinos.</p>
    </div>
  </div>

  <!-- RIGHT PANEL -->
  <div style="flex: 1; display: flex; align-items: center; justify-content: center; padding: 48px 56px; overflow-y: auto;">
    <div style="width: 100%; max-width: 380px;">

      <!-- STEP 1: verificar e-mail -->
      <div id="step1" class="step active">
        <div style="margin-bottom: 28px;">
          <h1 style="font-size: 1.7rem; font-weight: 800; color: #0A0A0A; margin: 0 0 6px; letter-spacing: -0.03em;">Identificação</h1>
          <p style="color: #6B7280; font-size: 0.875rem; margin: 0;">Informe o e-mail cadastrado pelo seu personal trainer</p>
        </div>

        <div id="step1Error" style="display:none; background:#FFF1F2; border:1px solid #FECDD3; border-radius:10px; padding:11px 14px; margin-bottom:16px; font-size:0.83rem; color:#BE123C; font-weight:500;"></div>

        <div style="display: flex; flex-direction: column; gap: 16px;">
          <div>
            <label style="display:block; font-size:0.78rem; font-weight:700; color:#374151; margin-bottom:7px;">Seu e-mail</label>
            <input type="email" id="emailInput" class="pa-input" placeholder="seu@email.com" autocomplete="email">
          </div>
          <button id="checkEmailBtn" class="pa-btn">Continuar →</button>
        </div>

        <p style="text-align:center; margin-top:20px; font-size:0.875rem; color:#6B7280;">
          Já tem senha? <a href="#/login" style="color:#0A0A0A; font-weight:700; text-decoration:none;">Fazer login →</a>
        </p>
      </div>

      <!-- STEP 2: definir senha -->
      <div id="step2" class="step">
        <!-- Boas-vindas personalizadas -->
        <div style="background:#ECFDF5; border:1px solid #A7F3D0; border-radius:12px; padding:14px 16px; margin-bottom:24px; display:flex; align-items:center; gap:12px;">
          <div style="width:36px;height:36px;background:#00E676;border-radius:10px;display:flex;align-items:center;justify-content:center;flex-shrink:0;">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#0A0A0A" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg>
          </div>
          <div>
            <p style="font-size:0.78rem;font-weight:700;color:#047857;margin:0 0 2px;">Conta encontrada!</p>
            <p id="welcomeName" style="font-size:0.875rem;font-weight:600;color:#0A0A0A;margin:0;"></p>
          </div>
        </div>

        <div style="margin-bottom:24px;">
          <h1 style="font-size:1.7rem;font-weight:800;color:#0A0A0A;margin:0 0 6px;letter-spacing:-0.03em;">Defina sua senha</h1>
          <p style="color:#6B7280;font-size:0.875rem;margin:0;">Crie uma senha para acessar sua conta</p>
        </div>

        <div id="step2Error" style="display:none; background:#FFF1F2; border:1px solid #FECDD3; border-radius:10px; padding:11px 14px; margin-bottom:16px; font-size:0.83rem; color:#BE123C; font-weight:500;"></div>

        <div style="display:flex;flex-direction:column;gap:16px;">
          <div>
            <label style="display:block;font-size:0.78rem;font-weight:700;color:#374151;margin-bottom:7px;">Nova senha</label>
            <input type="password" id="passwordInput" class="pa-input" placeholder="Mínimo 6 caracteres" autocomplete="new-password" minlength="6">
          </div>
          <div>
            <label style="display:block;font-size:0.78rem;font-weight:700;color:#374151;margin-bottom:7px;">Confirmar senha</label>
            <input type="password" id="passwordConfirmInput" class="pa-input" placeholder="Repita a senha" autocomplete="new-password" minlength="6">
          </div>
          <button id="activateBtn" class="pa-btn">Ativar minha conta</button>
          <button id="backBtn" style="background:none;border:none;color:#9CA3AF;font-size:0.82rem;cursor:pointer;font-family:inherit;padding:0;">← Usar outro e-mail</button>
        </div>
      </div>

    </div>
  </div>
</div>

<style>
@media (max-width: 768px) {
  .pa-left { display: none !important; }
}
</style>

<script>
(function() {

  // Estado local
  let pendingStudentDocId = null;
  let pendingEmail        = null;
  let isActivating        = false;  // guard contra duplo clique / dupla chamada

  // ── Elementos ─────────────────────────────────────────────────────
  const step1       = document.getElementById('step1');
  const step2       = document.getElementById('step2');
  const step1Error  = document.getElementById('step1Error');
  const step2Error  = document.getElementById('step2Error');

  function goStep(n) {
    step1.classList.toggle('active', n === 1);
    step2.classList.toggle('active', n === 2);
  }

  function showError(div, msg) {
    div.textContent = msg;
    div.style.display = 'block';
  }

  function hideError(div) {
    div.style.display = 'none';
  }

  // ── STEP 1: verificar e-mail ──────────────────────────────────────
  const checkEmailBtn = document.getElementById('checkEmailBtn');
  const emailInput    = document.getElementById('emailInput');

  async function checkEmail() {
    hideError(step1Error);
    const email = emailInput.value.trim();

    if (!email) return showError(step1Error, 'Informe seu e-mail.');

    checkEmailBtn.innerHTML = '<span class="spinner"></span>';
    checkEmailBtn.disabled  = true;

    const result = await authManager.checkPendingStudent(email);

    if (result.exists) {
      pendingStudentDocId = result.studentDocId;
      pendingEmail        = email;
      document.getElementById('welcomeName').textContent = result.name;
      goStep(2);
      setTimeout(() => document.getElementById('passwordInput').focus(), 100);
    } else if (result.alreadyActive) {
      step1Error.innerHTML = 'Esta conta já foi ativada. <a href="#/login" style="color:#BE123C;font-weight:700;">Faça login →</a>';
      step1Error.style.display = 'block';
    } else if (result.noIndex) {
      step1Error.innerHTML = 'Conta encontrada mas precisa ser reconfigurada. Peça ao seu personal para remover e recadastrar seu e-mail no painel.';
      step1Error.style.display = 'block';
    } else {
      showError(step1Error, 'Nenhuma conta pendente encontrada para este e-mail. Verifique com seu personal trainer.');
    }

    checkEmailBtn.innerHTML = 'Continuar →';
    checkEmailBtn.disabled  = false;
  }

  checkEmailBtn.onclick = checkEmail;
  emailInput.addEventListener('keydown', e => { if (e.key === 'Enter') checkEmail(); });

  // ── STEP 2: ativar conta ──────────────────────────────────────────
  const activateBtn           = document.getElementById('activateBtn');
  const passwordInput         = document.getElementById('passwordInput');
  const passwordConfirmInput  = document.getElementById('passwordConfirmInput');

  document.getElementById('backBtn').onclick = () => {
    pendingStudentDocId = null;
    pendingEmail        = null;
    hideError(step2Error);
    passwordInput.value        = '';
    passwordConfirmInput.value = '';
    goStep(1);
  };

  async function activate() {
    if (isActivating) return;
    hideError(step2Error);
    const password = passwordInput.value;
    const confirm  = passwordConfirmInput.value;

    if (password.length < 6)  return showError(step2Error, 'A senha deve ter pelo menos 6 caracteres.');
    if (password !== confirm)  return showError(step2Error, 'As senhas nao conferem.');

    isActivating          = true;
    activateBtn.innerHTML = '<span class="spinner"></span>';
    activateBtn.disabled  = true;

    const result = await authManager.activateStudentAccount(pendingEmail, password, pendingStudentDocId);

    if (result.success) {
      activateBtn.closest('div[style]').innerHTML = `
        <div style="text-align:center;padding:20px 0;">
          <div style="width:56px;height:56px;background:#00E676;border-radius:16px;margin:0 auto 18px;display:flex;align-items:center;justify-content:center;">
            <svg width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="#0A0A0A" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg>
          </div>
          <h2 style="font-size:1.4rem;font-weight:800;color:#0A0A0A;margin:0 0 8px;">Conta ativada!</h2>
          <p style="color:#6B7280;font-size:0.875rem;margin:0 0 24px;">Redirecionando para seus treinos...</p>
          <div class="spinner" style="margin:0 auto;"></div>
        </div>
      `;
      setTimeout(() => router.goToStudentDashboard(), 2000);
    } else {
      showError(step2Error, result.error || 'Erro ao ativar conta. Tente novamente.');
      activateBtn.innerHTML = 'Ativar minha conta';
      activateBtn.disabled  = false;
      isActivating = false;
    }
  }

  activateBtn.onclick = activate;
  passwordConfirmInput.addEventListener('keydown', e => { if (e.key === 'Enter') activate(); });

})();
</script>
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    function isAuth() {
      return request.auth != null;
    }

    function isUser(userId) {
      return isAuth() && request.auth.uid == userId;
    }

    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    function isPersonal() {
      return isAuth() && getUserData().userType == 'personal';
    }


    // ── USERS ────────────────────────────────────────────────────────────
    match /users/{userId} {
      allow read: if isAuth();
      allow create: if isUser(userId);
      allow update: if isUser(userId) || isPersonal();
      allow delete: if false;
    }


    // ── EXERCISES ────────────────────────────────────────────────────────
    // "Prontos" (dono do site): personalId == "" ou campo ausente → todos leem
    // Do personal: personalId == uid → só ele lê/edita
    match /exercises/{exerciseId} {
      allow read: if isAuth() && (
        resource == null ||
        resource.data.personalId == "" ||
        !("personalId" in resource.data) ||
        resource.data.personalId == request.auth.uid ||
        getUserData().personalId == resource.data.personalId
      );
      allow create: if isAuth() && isPersonal() &&
        request.resource.data.personalId == request.auth.uid;
      allow update: if isAuth() && isPersonal() &&
        resource.data.personalId == request.auth.uid;
      allow delete: if isAuth() && isPersonal() &&
        resource.data.personalId == request.auth.uid;
    }


    // ── WORKOUTS ─────────────────────────────────────────────────────────
    match /workouts/{workoutId} {
      allow get: if isAuth() && (
        resource.data.personalId == request.auth.uid ||
        resource.data.studentId == request.auth.uid
      );
      allow list: if isAuth();
      allow create: if isAuth() &&
        request.resource.data.personalId == request.auth.uid;
      allow update, delete: if isAuth() &&
        resource.data.personalId == request.auth.uid;
    }


    // ── FEEDBACKS ────────────────────────────────────────────────────────
    match /feedbacks/{feedbackId} {
      allow create: if isAuth() &&
        request.resource.data.studentId == request.auth.uid;
      allow get, update: if isAuth() && (
        resource == null ||
        resource.data.studentId == request.auth.uid
      );
      allow get, delete: if isAuth() && isPersonal() && (
        resource == null ||
        (
          exists(/databases/$(database)/documents/workouts/$(resource.data.workoutId)) &&
          get(/databases/$(database)/documents/workouts/$(resource.data.workoutId)).data.personalId == request.auth.uid
        )
      );
      allow list: if isAuth();
    }


    // ── REFERRAL CODES ─────────────────────────────────────────────────
    match /referralCodes/{code} {
      allow read: if true;
      allow create: if isAuth() && isPersonal();
      allow update, delete: if false;
    }


    // ── BLOQUEIO PADRÃO ───────────────────────────────────────────────
    match /{document=**} {
      allow read, write: if false;
    }
  }
}

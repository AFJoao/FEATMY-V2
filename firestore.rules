rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    function isAuth() {
      return request.auth != null;
    }

    function isUser(userId) {
      return isAuth() && request.auth.uid == userId;
    }

    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    function isPersonal() {
      return isAuth() && getUserData().userType == 'personal';
    }


    // ── USERS ────────────────────────────────────────────────────────────
    // Qualquer autenticado lê qualquer usuário.
    // Necessário para queries: where('personalId','==',uid), where('userType','==','student')
    match /users/{userId} {
      allow read: if isAuth();
      allow create: if isUser(userId);
      allow update: if isUser(userId) || isPersonal();
      allow delete: if false;
    }


    // ── EXERCISES ────────────────────────────────────────────────────────
    match /exercises/{exerciseId} {
      allow read: if isAuth() && (
        resource == null ||
        resource.data.personalId == request.auth.uid ||
        resource.data.createdBy == request.auth.uid ||
        getUserData().personalId == resource.data.personalId ||
        getUserData().personalId == resource.data.createdBy
      );
      allow create: if isAuth() && isPersonal() && (
        request.resource.data.personalId == request.auth.uid ||
        request.resource.data.createdBy == request.auth.uid
      );
      allow update: if isAuth() && isPersonal() && (
        resource.data.personalId == request.auth.uid ||
        resource.data.createdBy == request.auth.uid
      );
      allow delete: if isAuth() && isPersonal() && (
        resource.data.personalId == request.auth.uid ||
        resource.data.createdBy == request.auth.uid
      );
    }


    // ── WORKOUTS ─────────────────────────────────────────────────────────
    match /workouts/{workoutId} {

      // GET direto por ID: personal que criou OU aluno atribuído
      allow get: if isAuth() && (
        resource.data.personalId == request.auth.uid ||
        resource.data.studentId == request.auth.uid
      );

      // LIST (query): permite para qualquer autenticado.
      // A segurança real está no .where() feito pelo código — o Firestore
      // retorna apenas os docs que batem com o filtro, e a rule de get
      // garante que só o dono/aluno lê o documento individualmente.
      // Sem isso, qualquer .where(...).get() retorna "insufficient permissions".
      allow list: if isAuth();

      // Personal cria
      allow create: if isAuth() &&
        request.resource.data.personalId == request.auth.uid;

      // Personal edita/deleta seus treinos
      allow update, delete: if isAuth() &&
        resource.data.personalId == request.auth.uid;
    }


    // ── FEEDBACKS ────────────────────────────────────────────────────────
    match /feedbacks/{feedbackId} {
      allow create: if isAuth() &&
        request.resource.data.studentId == request.auth.uid;

      allow read, update: if isAuth() && resource != null &&
        resource.data.studentId == request.auth.uid;

      allow read: if isAuth() && isPersonal() && resource != null &&
        exists(/databases/$(database)/documents/workouts/$(resource.data.workoutId)) &&
        get(/databases/$(database)/documents/workouts/$(resource.data.workoutId)).data.personalId == request.auth.uid;

      allow delete: if isAuth() && isPersonal() && resource != null &&
        exists(/databases/$(database)/documents/workouts/$(resource.data.workoutId)) &&
        get(/databases/$(database)/documents/workouts/$(resource.data.workoutId)).data.personalId == request.auth.uid;
    }


    // ── REFERRAL CODES ─────────────────────────────────────────────────
    match /referralCodes/{code} {
      allow read: if true;
      allow create: if isAuth() && isPersonal();
      allow update, delete: if false;
    }


    // ── BLOQUEIO PADRÃO ───────────────────────────────────────────────
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
